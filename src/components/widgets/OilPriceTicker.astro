---
// Oil Price Ticker Component
// Fetches WTI and Brent crude oil prices from EIA API
// API Key should be set in environment variable EIA_API_KEY

interface Props {
  variant?: 'desktop' | 'mobile';
}

const { variant = 'desktop' } = Astro.props;
---

{
  variant === 'desktop' ? (
    <div class="oil-ticker oil-ticker-desktop" id="oilPriceTicker">
      <div class="oil-ticker-inner">
        <div class="oil-price">
          <span class="oil-label">WTI</span>
          <span class="oil-value wti-value">--</span>
          <span class="oil-change wti-change" />
        </div>
        <div class="oil-divider" />
        <div class="oil-price">
          <span class="oil-label">BRENT</span>
          <span class="oil-value brent-value">--</span>
          <span class="oil-change brent-change" />
        </div>
      </div>
    </div>
  ) : (
    <div class="oil-ticker-mobile" id="oilPriceTickerMobile">
      <div class="oil-ticker-mobile-inner">
        <div class="oil-price">
          <span class="oil-label">WTI</span>
          <span class="oil-value wti-value">--</span>
          <span class="oil-change wti-change" />
        </div>
        <div class="oil-divider" />
        <div class="oil-price">
          <span class="oil-label">BRENT</span>
          <span class="oil-value brent-value">--</span>
          <span class="oil-change brent-change" />
        </div>
      </div>
    </div>
  )
}

<style>
  /* ============================================
     SHARED STYLES
     ============================================ */
  .oil-price {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .oil-label {
    color: var(--mtn-orange, #ff6600);
    font-weight: 700;
    font-size: 0.6875rem;
    letter-spacing: 0.5px;
  }

  .oil-value {
    color: var(--mtn-white, #ffffff);
    font-weight: 600;
    font-family: 'Space Grotesk', monospace;
  }

  .oil-change {
    font-size: 0.625rem;
    font-weight: 600;
  }

  .oil-change.up {
    color: #22c55e;
  }

  .oil-change.down {
    color: #ef4444;
  }

  .oil-divider {
    width: 1px;
    height: 16px;
    background: rgba(255, 255, 255, 0.2);
  }

  /* Loading state */
  .loading .oil-value {
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* Error state */
  .error {
    opacity: 0.6;
  }

  /* ============================================
     DESKTOP TICKER (in top bar)
     ============================================ */
  .oil-ticker-desktop {
    display: flex;
    align-items: center;
    background: rgba(255, 102, 0, 0.15);
    border: 1px solid rgba(255, 102, 0, 0.3);
    border-radius: 4px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    flex-shrink: 0;
  }

  .oil-ticker-inner {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  /* Hide desktop ticker on mobile/tablet */
  @media (max-width: 1024px) {
    .oil-ticker-desktop {
      display: none;
    }
  }

  /* Adjust for medium screens */
  @media (max-width: 1200px) and (min-width: 1025px) {
    .oil-ticker-desktop {
      padding: 0.25rem 0.5rem;
    }

    .oil-ticker-inner {
      gap: 0.5rem;
    }
  }

  /* ============================================
     MOBILE BAR (above header)
     ============================================ */
  .oil-ticker-mobile {
    display: none;
    width: 100%;
    background: var(--mtn-dark, #1a1a1a);
    border-bottom: 1px solid rgba(255, 102, 0, 0.3);
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
  }

  .oil-ticker-mobile-inner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
  }

  /* Show mobile bar only on mobile/tablet */
  @media (max-width: 1024px) {
    .oil-ticker-mobile {
      display: block;
    }
  }
</style>

<script>
  // EIA API Configuration
  // The API key will be injected at build time or can be set here
  // Trim any accidental whitespace/newlines from the key
  const EIA_API_KEY = (import.meta.env.PUBLIC_EIA_API_KEY || '').trim();

  // EIA API v2 series codes
  // WTI Cushing, OK Spot Price FOB
  const WTI_SERIES = 'RWTC';
  // Brent Europe Spot Price FOB
  const BRENT_SERIES = 'RBRTE';

  const EIA_API_BASE = 'https://api.eia.gov/v2/petroleum/pri/spt/data/';

  interface EIAResponse {
    response: {
      data: Array<{
        value: number;
        period: string;
        series: string;
      }>;
    };
  }

  interface OilPrices {
    wti: { current: number; previous: number } | null;
    brent: { current: number; previous: number } | null;
    lastUpdated: Date;
  }

  let cachedPrices: OilPrices | null = null;
  let lastFetchTime: number = 0;
  const CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds

  async function fetchOilPrice(seriesCode: string): Promise<{ current: number; previous: number } | null> {
    if (!EIA_API_KEY) {
      console.warn('EIA API key not configured. Set PUBLIC_EIA_API_KEY in environment.');
      return null;
    }

    try {
      // Build the URL with proper EIA API v2 format
      const url = new URL(EIA_API_BASE);
      url.searchParams.set('api_key', EIA_API_KEY);
      url.searchParams.set('frequency', 'daily');
      url.searchParams.append('data[]', 'value');
      url.searchParams.append('facets[series][]', seriesCode);
      url.searchParams.set('sort[0][column]', 'period');
      url.searchParams.set('sort[0][direction]', 'desc');
      url.searchParams.set('offset', '0');
      url.searchParams.set('length', '2');

      const response = await fetch(url.toString());

      if (!response.ok) {
        throw new Error(`EIA API error: ${response.status}`);
      }

      const data: EIAResponse = await response.json();

      if (data.response?.data && data.response.data.length >= 1) {
        const current = parseFloat(data.response.data[0].value as unknown as string);
        const previous =
          data.response.data.length > 1 ? parseFloat(data.response.data[1].value as unknown as string) : current;
        return { current, previous };
      }

      return null;
    } catch (error) {
      console.error(`Error fetching oil price for ${seriesCode}:`, error);
      return null;
    }
  }

  async function fetchAllPrices(): Promise<OilPrices> {
    const now = Date.now();

    // Return cached data if still valid
    if (cachedPrices && now - lastFetchTime < CACHE_DURATION) {
      return cachedPrices;
    }

    const [wti, brent] = await Promise.all([fetchOilPrice(WTI_SERIES), fetchOilPrice(BRENT_SERIES)]);

    cachedPrices = {
      wti,
      brent,
      lastUpdated: new Date(),
    };
    lastFetchTime = now;

    return cachedPrices;
  }

  function formatPrice(price: number): string {
    return `$${price.toFixed(2)}`;
  }

  function formatChange(current: number, previous: number): { text: string; direction: 'up' | 'down' | 'neutral' } {
    const change = current - previous;
    const percentChange = ((change / previous) * 100).toFixed(2);

    if (change > 0) {
      return { text: `+${percentChange}%`, direction: 'up' };
    } else if (change < 0) {
      return { text: `${percentChange}%`, direction: 'down' };
    }
    return { text: '0.00%', direction: 'neutral' };
  }

  function updateDisplay(prices: OilPrices): void {
    const desktopTicker = document.getElementById('oilPriceTicker');
    const mobileTicker = document.getElementById('oilPriceTickerMobile');

    // Get all elements by class (both desktop and mobile)
    const wtiValueEls = document.querySelectorAll('.wti-value');
    const wtiChangeEls = document.querySelectorAll('.wti-change');
    const brentValueEls = document.querySelectorAll('.brent-value');
    const brentChangeEls = document.querySelectorAll('.brent-change');

    // Remove loading/error states
    desktopTicker?.classList.remove('loading', 'error');
    mobileTicker?.classList.remove('loading', 'error');

    if (prices.wti) {
      const wtiChange = formatChange(prices.wti.current, prices.wti.previous);
      wtiValueEls.forEach((el) => (el.textContent = formatPrice(prices.wti!.current)));
      wtiChangeEls.forEach((el) => {
        el.textContent = wtiChange.text;
        el.className = `oil-change wti-change ${wtiChange.direction}`;
      });
    }

    if (prices.brent) {
      const brentChange = formatChange(prices.brent.current, prices.brent.previous);
      brentValueEls.forEach((el) => (el.textContent = formatPrice(prices.brent!.current)));
      brentChangeEls.forEach((el) => {
        el.textContent = brentChange.text;
        el.className = `oil-change brent-change ${brentChange.direction}`;
      });
    }

    if (!prices.wti && !prices.brent) {
      desktopTicker?.classList.add('error');
      mobileTicker?.classList.add('error');
    }
  }

  async function initOilTicker(): Promise<void> {
    const desktopTicker = document.getElementById('oilPriceTicker');
    const mobileTicker = document.getElementById('oilPriceTickerMobile');

    if (!desktopTicker && !mobileTicker) return;

    // Show loading state
    desktopTicker?.classList.add('loading');
    mobileTicker?.classList.add('loading');

    try {
      const prices = await fetchAllPrices();
      updateDisplay(prices);
    } catch (error) {
      console.error('Error initializing oil ticker:', error);
      desktopTicker?.classList.remove('loading');
      desktopTicker?.classList.add('error');
      mobileTicker?.classList.remove('loading');
      mobileTicker?.classList.add('error');
    }

    // Set up hourly refresh
    setInterval(async () => {
      try {
        // Force cache invalidation for refresh
        lastFetchTime = 0;
        const prices = await fetchAllPrices();
        updateDisplay(prices);
      } catch (error) {
        console.error('Error refreshing oil prices:', error);
      }
    }, CACHE_DURATION);
  }

  // Initialize on load
  initOilTicker();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', () => {
    initOilTicker();
  });
</script>

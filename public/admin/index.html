<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>MTN MUD Admin</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #1a1a2e;
        color: #fff;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Login */
      .login-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .login-box {
        background: #2a2a4a;
        padding: 40px;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .login-box h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #ff6600;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #ccc;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #3a3a5a;
        border-radius: 8px;
        background: #1a1a2e;
        color: #fff;
        font-size: 16px;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #ff6600;
      }

      .btn {
        display: inline-block;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #ff6600;
        color: #fff;
        width: 100%;
      }
      .btn-primary:hover {
        background: #ff8533;
      }
      .btn-primary:disabled {
        background: #666;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: #3a3a5a;
        color: #fff;
      }
      .btn-secondary:hover {
        background: #4a4a6a;
      }
      .btn-danger {
        background: #dc3545;
        color: #fff;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .btn-small {
        padding: 8px 16px;
        font-size: 14px;
      }

      .error-message {
        color: #ff6b6b;
        text-align: center;
        margin-top: 15px;
        display: none;
      }

      .success-message {
        color: #4ade80;
        text-align: center;
        margin-top: 15px;
        display: none;
      }

      /* Dashboard */
      .dashboard {
        display: none;
      }
      .dashboard.active {
        display: block;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #3a3a5a;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .admin-header h1 {
        color: #ff6600;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .tab {
        padding: 12px 24px;
        background: #2a2a4a;
        border: none;
        border-radius: 8px;
        color: #ccc;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .tab:hover {
        background: #3a3a5a;
      }
      .tab.active {
        background: #ff6600;
        color: #fff;
      }

      .panel {
        display: none;
      }
      .panel.active {
        display: block;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: #2a2a4a;
        border-radius: 12px;
        overflow: hidden;
        min-width: 600px;
      }

      .data-table th,
      .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #3a3a5a;
      }

      .data-table th {
        background: #1a1a2e;
        color: #ff6600;
        font-weight: 600;
      }

      .data-table tr:hover {
        background: #3a3a5a;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background: #28a745;
        color: #fff;
      }
      .badge-warning {
        background: #ffc107;
        color: #000;
      }
      .badge-danger {
        background: #dc3545;
        color: #fff;
      }

      /* Modal */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: #2a2a4a;
        padding: 30px;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal h2 {
        margin-bottom: 20px;
        color: #ff6600;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .add-button {
        margin-bottom: 20px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .checkbox-group input[type='checkbox'] {
        width: 20px;
        height: 20px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #ccc;
      }

      .rebuild-notice {
        background: #ff6600;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .rebuild-notice.active {
        display: block;
      }

      .status-bar {
        background: #2a2a4a;
        padding: 10px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #ccc;
      }

      /* PDF Upload */
      .file-upload {
        border: 2px dashed #3a3a5a;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .file-upload:hover {
        border-color: #ff6600;
        background: rgba(255, 102, 0, 0.1);
      }
      .file-upload.has-file {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
      }
      .file-upload input[type='file'] {
        display: none;
      }
      .file-upload-text {
        color: #ccc;
        font-size: 14px;
      }
      .file-upload-text .filename {
        color: #4ade80;
        font-weight: 600;
      }
      .current-pdf {
        margin-top: 10px;
        padding: 10px;
        background: #1a1a2e;
        border-radius: 6px;
        font-size: 13px;
      }
      .current-pdf a {
        color: #ff6600;
        text-decoration: none;
      }
      .current-pdf a:hover {
        text-decoration: underline;
      }
      .remove-pdf {
        color: #dc3545;
        cursor: pointer;
        margin-left: 10px;
        font-size: 12px;
      }
      .remove-pdf:hover {
        text-decoration: underline;
      }
      .upload-progress {
        margin-top: 10px;
        height: 4px;
        background: #3a3a5a;
        border-radius: 2px;
        overflow: hidden;
        display: none;
      }
      .upload-progress.active {
        display: block;
      }
      .upload-progress-bar {
        height: 100%;
        background: #ff6600;
        width: 0%;
        transition: width 0.3s;
      }

      /* Category select with add button */
      .category-select-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }
      .category-select-wrapper select {
        flex: 1;
      }
      .btn-add-category {
        padding: 12px;
        font-size: 18px;
        line-height: 1;
        min-width: 44px;
      }

      /* Small modal for adding category */
      .modal-small {
        max-width: 350px;
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
      <div class="login-box">
        <h1>MTN MUD Admin</h1>
        <form id="loginForm">
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required placeholder="Enter admin password" />
          </div>
          <button type="submit" class="btn btn-primary" id="loginBtn">Log In</button>
          <p class="error-message" id="loginError">Invalid password. Please try again.</p>
        </form>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
      <div class="container">
        <div class="admin-header">
          <h1>MTN MUD Admin</h1>
          <button class="btn btn-secondary" id="logoutBtn">Log Out</button>
        </div>

        <div id="rebuildNotice" class="rebuild-notice">
          Changes saved! The site will rebuild automatically. Changes will appear in 1-2 minutes.
        </div>

        <div class="status-bar" id="statusBar">
          <span id="statusText">Loading content...</span>
          <button class="btn btn-secondary btn-small" id="refreshBtn" style="margin-left: 15px; display: none">
            Refresh from Database
          </button>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="products">Products</button>
          <button class="tab" data-tab="jobs">Jobs</button>
        </div>

        <!-- Products Panel -->
        <div class="panel active" id="products-panel">
          <button class="btn btn-primary add-button" id="addProductBtn">+ Add Product</button>
          <div id="productsLoading" class="loading">Loading products...</div>
          <div class="table-container">
            <table class="data-table" id="productsTable" style="display: none">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Size</th>
                  <th>Order</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Jobs Panel -->
        <div class="panel" id="jobs-panel">
          <button class="btn btn-primary add-button" id="addJobBtn">+ Add Job</button>
          <div id="jobsLoading" class="loading">Loading jobs...</div>
          <div class="table-container">
            <table class="data-table" id="jobsTable" style="display: none">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Locations</th>
                  <th>Order</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="jobsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
      <div class="modal">
        <h2 id="productModalTitle">Add Product</h2>
        <form id="productForm">
          <input type="hidden" id="productSlug" />
          <input type="hidden" id="productSha" />
          <input type="hidden" id="productPdfPath" />
          <div class="form-group">
            <label for="productTitle">Title *</label>
            <input type="text" id="productTitle" required />
          </div>
          <div class="form-group">
            <label for="productCategory">Category *</label>
            <div class="category-select-wrapper">
              <select id="productCategory" required>
                <option value="">Select a category...</option>
              </select>
              <button
                type="button"
                class="btn btn-secondary btn-add-category"
                onclick="openCategoryModal()"
                title="Add new category"
              >
                +
              </button>
            </div>
          </div>
          <div class="form-group">
            <label for="productSize">Size</label>
            <input type="text" id="productSize" placeholder="e.g., 50 LBS" />
          </div>
          <div class="form-group">
            <label for="productOrder">Sort Order</label>
            <input type="number" id="productOrder" value="0" />
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="productInStock" checked />
            <label for="productInStock">In Stock</label>
          </div>
          <div class="form-group">
            <label>Product PDF (spec sheet, SDS, etc.)</label>
            <div class="file-upload" id="pdfUploadArea">
              <input type="file" id="productPdfFile" accept=".pdf" />
              <div class="file-upload-text" id="pdfUploadText">Click or drag to upload PDF (max 20MB)</div>
            </div>
            <div class="upload-progress" id="pdfUploadProgress">
              <div class="upload-progress-bar" id="pdfUploadProgressBar"></div>
            </div>
            <div class="current-pdf" id="currentPdfInfo" style="display: none">
              Current: <a id="currentPdfLink" href="#" target="_blank"></a>
              <span class="remove-pdf" onclick="removePdf()">Remove</span>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="productSaveBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Job Modal -->
    <div class="modal-overlay" id="jobModal">
      <div class="modal">
        <h2 id="jobModalTitle">Add Job</h2>
        <form id="jobForm">
          <input type="hidden" id="jobSlug" />
          <input type="hidden" id="jobSha" />
          <div class="form-group">
            <label for="jobTitle">Title *</label>
            <input type="text" id="jobTitle" required />
          </div>
          <div class="form-group">
            <label for="jobLocations">Locations</label>
            <input type="text" id="jobLocations" placeholder="e.g., Gillette, WY / Williston, ND" />
          </div>
          <div class="form-group">
            <label for="jobOrder">Sort Order</label>
            <input type="number" id="jobOrder" value="0" />
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="jobActive" checked />
            <label for="jobActive">Active (visible on site)</label>
          </div>
          <div class="form-group">
            <label for="jobBody">Job Description (Markdown)</label>
            <textarea id="jobBody" rows="6" placeholder="Enter job description..."></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeJobModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="jobSaveBtn">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal-overlay" id="categoryModal">
      <div class="modal modal-small">
        <h2>Add New Category</h2>
        <form id="categoryForm">
          <div class="form-group">
            <label for="newCategoryName">Category Name *</label>
            <input type="text" id="newCategoryName" required placeholder="e.g., Specialty Chemicals" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Category</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // ============================================
      // CONFIGURATION
      // ============================================
      const CONFIG = {
        productsPath: 'src/content/products',
        jobsPath: 'src/content/jobs',
        pdfsPath: 'public/pdfs/products',
        cacheKey: 'mtn_admin_cache',
        categoriesKey: 'mtn_admin_categories',
        maxPdfSize: 20 * 1024 * 1024, // 20MB
      };

      // Session token from auth
      let sessionToken = '';

      // Categories list (stored in localStorage)
      let categories = [];

      // Pending PDF upload data
      let pendingPdfFile = null;
      let pendingPdfRemove = false;

      // ============================================
      // CACHE HELPERS
      // ============================================

      function getCache() {
        try {
          const cached = localStorage.getItem(CONFIG.cacheKey);
          if (cached) {
            return JSON.parse(cached);
          }
        } catch (e) {
          console.error('Cache read error:', e);
        }
        return null;
      }

      function setCache(data) {
        try {
          localStorage.setItem(
            CONFIG.cacheKey,
            JSON.stringify({
              ...data,
              timestamp: Date.now(),
            })
          );
        } catch (e) {
          console.error('Cache write error:', e);
        }
      }

      function clearCache() {
        localStorage.removeItem(CONFIG.cacheKey);
      }

      // ============================================
      // INITIALIZATION
      // ============================================

      function checkSession() {
        const storedToken = sessionStorage.getItem('admin_token');
        if (storedToken) {
          sessionToken = storedToken;
          showDashboard();
          loadData();
        }
      }

      // ============================================
      // AUTH - Now uses serverless function
      // ============================================

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');

        errorEl.style.display = 'none';
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';

        try {
          const response = await fetch('/api/auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password }),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            sessionToken = data.token;
            sessionStorage.setItem('admin_token', sessionToken);
            showDashboard();
            loadData();
          } else {
            errorEl.textContent = data.error || 'Invalid password.';
            errorEl.style.display = 'block';
          }
        } catch (err) {
          errorEl.textContent = 'Connection error. Please try again.';
          errorEl.style.display = 'block';
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Log In';
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        sessionStorage.removeItem('admin_token');
        sessionToken = '';
        location.reload();
      });

      function showDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
      }

      // ============================================
      // TABS
      // ============================================

      document.querySelectorAll('.tab').forEach((tab) => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach((t) => t.classList.remove('active'));
          document.querySelectorAll('.panel').forEach((p) => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab + '-panel').classList.add('active');
        });
      });

      // ============================================
      // API HELPERS - Now uses serverless proxy
      // ============================================

      async function apiRequest(action, path, options = {}) {
        const response = await fetch('/api/github', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${sessionToken}`,
          },
          body: JSON.stringify({
            action,
            path,
            ...options,
          }),
        });

        if (response.status === 401) {
          // Session expired
          sessionStorage.removeItem('admin_token');
          alert('Session expired. Please log in again.');
          location.reload();
          return null;
        }

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || `API error: ${response.status}`);
        }

        return response.json();
      }

      async function getFiles(path) {
        try {
          return await apiRequest('list', path);
        } catch (err) {
          console.error('Error fetching files:', err);
          return [];
        }
      }

      async function getFileContent(path) {
        const file = await apiRequest('get', path);
        const content = atob(file.content);
        return { content, sha: file.sha };
      }

      async function saveFile(path, content, sha = null, message = 'Update via admin') {
        await apiRequest('save', path, { content, sha, message });
      }

      async function deleteFile(path, sha, message = 'Delete via admin') {
        await apiRequest('delete', path, { sha, message });
      }

      // ============================================
      // PDF UPLOAD
      // ============================================

      async function uploadPdf(file, productSlug) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async () => {
            try {
              // Get base64 content (remove data URL prefix)
              const base64Content = reader.result.split(',')[1];
              const pdfPath = `${CONFIG.pdfsPath}/${productSlug}.pdf`;

              // Check if file already exists (to get sha for update)
              let existingSha = null;
              try {
                const existing = await apiRequest('get', pdfPath);
                if (existing && existing.sha) {
                  existingSha = existing.sha;
                }
              } catch {
                // File doesn't exist, that's fine
              }

              // Upload the PDF
              await apiRequest('upload', pdfPath, {
                content: base64Content,
                sha: existingSha,
                message: `Upload PDF for ${productSlug}`,
              });

              resolve(`/pdfs/products/${productSlug}.pdf`);
            } catch (err) {
              reject(err);
            }
          };
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsDataURL(file);
        });
      }

      async function deletePdf(pdfPath) {
        // Convert public path to repo path
        const repoPath = pdfPath.startsWith('/') ? 'public' + pdfPath : 'public/' + pdfPath;

        try {
          // Get the sha of the existing file
          const existing = await apiRequest('get', repoPath);
          if (existing && existing.sha) {
            await apiRequest('delete', repoPath, {
              sha: existing.sha,
              message: 'Delete product PDF',
            });
          }
        } catch {
          // File might not exist, that's okay
        }
      }

      // PDF Upload UI handlers
      function setupPdfUpload() {
        const uploadArea = document.getElementById('pdfUploadArea');
        const fileInput = document.getElementById('productPdfFile');
        const uploadText = document.getElementById('pdfUploadText');

        // Click to upload
        uploadArea.addEventListener('click', () => fileInput.click());

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadArea.style.borderColor = '#ff6600';
        });

        uploadArea.addEventListener('dragleave', () => {
          uploadArea.style.borderColor = pendingPdfFile ? '#28a745' : '#3a3a5a';
        });

        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          const file = e.dataTransfer.files[0];
          if (file) handlePdfSelect(file);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handlePdfSelect(file);
        });
      }

      function handlePdfSelect(file) {
        const uploadArea = document.getElementById('pdfUploadArea');
        const uploadText = document.getElementById('pdfUploadText');

        // Validate file type
        if (file.type !== 'application/pdf') {
          alert('Please select a PDF file.');
          return;
        }

        // Validate file size
        if (file.size > CONFIG.maxPdfSize) {
          alert(`File is too large. Maximum size is ${CONFIG.maxPdfSize / 1024 / 1024}MB.`);
          return;
        }

        // Store the file for upload on save
        pendingPdfFile = file;
        pendingPdfRemove = false;

        // Update UI
        uploadArea.classList.add('has-file');
        uploadText.innerHTML = `<span class="filename">${file.name}</span> (${(file.size / 1024 / 1024).toFixed(2)}MB)`;

        // Hide current PDF info since we're replacing it
        document.getElementById('currentPdfInfo').style.display = 'none';
      }

      window.removePdf = function () {
        pendingPdfRemove = true;
        pendingPdfFile = null;

        // Reset upload area
        const uploadArea = document.getElementById('pdfUploadArea');
        const uploadText = document.getElementById('pdfUploadText');
        uploadArea.classList.remove('has-file');
        uploadText.textContent = 'Click or drag to upload PDF (max 20MB)';

        // Hide current PDF info
        document.getElementById('currentPdfInfo').style.display = 'none';
      };

      function resetPdfUpload() {
        pendingPdfFile = null;
        pendingPdfRemove = false;

        const uploadArea = document.getElementById('pdfUploadArea');
        const uploadText = document.getElementById('pdfUploadText');
        const fileInput = document.getElementById('productPdfFile');

        uploadArea.classList.remove('has-file');
        uploadText.textContent = 'Click or drag to upload PDF (max 20MB)';
        fileInput.value = '';
        document.getElementById('currentPdfInfo').style.display = 'none';
        document.getElementById('pdfUploadProgress').classList.remove('active');
      }

      // ============================================
      // CATEGORIES
      // ============================================

      function loadCategories() {
        try {
          const stored = localStorage.getItem(CONFIG.categoriesKey);
          if (stored) {
            categories = JSON.parse(stored);
          }
        } catch (e) {
          console.error('Error loading categories:', e);
          categories = [];
        }
      }

      function saveCategories() {
        try {
          localStorage.setItem(CONFIG.categoriesKey, JSON.stringify(categories));
        } catch (e) {
          console.error('Error saving categories:', e);
        }
      }

      function updateCategoriesFromProducts() {
        // Extract unique categories from products
        const productCategories = [...new Set(products.map((p) => p.category).filter(Boolean))];

        // Merge with existing categories (keep any user-added ones)
        productCategories.forEach((cat) => {
          if (!categories.includes(cat)) {
            categories.push(cat);
          }
        });

        // Sort alphabetically
        categories.sort((a, b) => a.localeCompare(b));
        saveCategories();
      }

      function renderCategoryDropdown(selectedValue = '') {
        const select = document.getElementById('productCategory');
        select.innerHTML = '<option value="">Select a category...</option>';

        categories.forEach((cat) => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          if (cat === selectedValue) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      }

      window.openCategoryModal = function () {
        document.getElementById('newCategoryName').value = '';
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('newCategoryName').focus();
      };

      window.closeCategoryModal = function () {
        document.getElementById('categoryModal').classList.remove('active');
      };

      document.getElementById('categoryForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const newCategory = document.getElementById('newCategoryName').value.trim();

        if (newCategory && !categories.includes(newCategory)) {
          categories.push(newCategory);
          categories.sort((a, b) => a.localeCompare(b));
          saveCategories();
          renderCategoryDropdown(newCategory);
        } else if (categories.includes(newCategory)) {
          // Category exists, just select it
          document.getElementById('productCategory').value = newCategory;
        }

        closeCategoryModal();
      });

      // ============================================
      // PRODUCTS
      // ============================================

      let products = [];

      function sortProducts() {
        products.sort((a, b) => {
          if (a.category !== b.category) return (a.category || '').localeCompare(b.category || '');
          return (a.order || 0) - (b.order || 0);
        });
      }

      async function loadProducts(fromGitHub = false) {
        if (!fromGitHub) return; // Only fetch if explicitly requested

        const files = await getFiles(CONFIG.productsPath);
        if (!files || !Array.isArray(files)) {
          document.getElementById('productsLoading').textContent = 'No products found or error loading.';
          return;
        }

        products = [];

        for (const file of files) {
          if (file.name.endsWith('.md')) {
            try {
              const { content, sha } = await getFileContent(file.path);
              const product = parseMarkdown(content);
              product.slug = file.name.replace('.md', '');
              product.sha = sha;
              product.path = file.path;
              products.push(product);
            } catch (err) {
              console.error('Error loading product:', file.name, err);
            }
          }
        }

        sortProducts();
        renderProducts();

        // Update categories list from loaded products
        updateCategoriesFromProducts();
      }

      function renderProducts() {
        const loading = document.getElementById('productsLoading');
        const table = document.getElementById('productsTable');
        const tbody = document.getElementById('productsBody');

        loading.style.display = 'none';
        table.style.display = 'table';

        tbody.innerHTML = products
          .map(
            (p) => `
        <tr>
          <td>${escapeHtml(p.title || '')}</td>
          <td>${escapeHtml(p.category || '')}</td>
          <td>${escapeHtml(p.size || '-')}</td>
          <td>${p.order || 0}</td>
          <td><span class="badge ${p.inStock !== false ? 'badge-success' : 'badge-danger'}">${p.inStock !== false ? 'In Stock' : 'Out of Stock'}</span></td>
          <td class="action-buttons">
            <button class="btn btn-secondary btn-small" onclick="editProduct('${p.slug}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteProduct('${p.slug}')">Delete</button>
          </td>
        </tr>
      `
          )
          .join('');
      }

      function openProductModal(product = null) {
        document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';
        document.getElementById('productSlug').value = product?.slug || '';
        document.getElementById('productSha').value = product?.sha || '';
        document.getElementById('productTitle').value = product?.title || '';
        document.getElementById('productSize').value = product?.size || '';
        document.getElementById('productOrder').value = product?.order || 0;
        document.getElementById('productInStock').checked = product?.inStock !== false;
        document.getElementById('productPdfPath').value = product?.pdf || '';

        // Render category dropdown and select current value
        renderCategoryDropdown(product?.category || '');

        // Reset PDF upload state
        resetPdfUpload();

        // Show current PDF if exists
        if (product?.pdf) {
          const currentPdfInfo = document.getElementById('currentPdfInfo');
          const currentPdfLink = document.getElementById('currentPdfLink');
          currentPdfLink.href = product.pdf;
          currentPdfLink.textContent = product.pdf.split('/').pop();
          currentPdfInfo.style.display = 'block';
        }

        document.getElementById('productModal').classList.add('active');
      }

      function closeProductModal() {
        document.getElementById('productModal').classList.remove('active');
      }

      window.editProduct = function (slug) {
        const product = products.find((p) => p.slug === slug);
        if (product) openProductModal(product);
      };

      window.deleteProduct = async function (slug) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        const productIndex = products.findIndex((p) => p.slug === slug);
        if (productIndex === -1) return;

        const product = products[productIndex];

        // Optimistic update - remove from local array immediately
        products.splice(productIndex, 1);
        renderProducts();
        setCache({ products, jobs });
        updateStatus(`Deleted "${product.title}". Saving to database...`);

        try {
          // Fetch the latest SHA to avoid 409 conflicts
          let currentSha = product.sha;
          try {
            const latestFile = await apiRequest('get', product.path);
            if (latestFile && latestFile.sha) {
              currentSha = latestFile.sha;
            }
          } catch {
            // Use existing sha if we can't fetch latest
          }

          await deleteFile(product.path, currentSha, `Delete product: ${product.title}`);
          showRebuildNotice();
          updateStatus(`Product "${product.title}" deleted successfully.`);
        } catch (err) {
          // Revert on error
          products.splice(productIndex, 0, product);
          renderProducts();
          setCache({ products, jobs });
          alert('Error deleting product: ' + err.message);
          updateStatus('Error deleting product.');
        }
      };

      document.getElementById('addProductBtn').addEventListener('click', () => openProductModal());

      document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const saveBtn = document.getElementById('productSaveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const existingSlug = document.getElementById('productSlug').value;
        const sha = document.getElementById('productSha').value;
        const title = document.getElementById('productTitle').value;
        const category = document.getElementById('productCategory').value;
        const size = document.getElementById('productSize').value;
        const order = parseInt(document.getElementById('productOrder').value) || 0;
        const inStock = document.getElementById('productInStock').checked;
        let pdfPath = document.getElementById('productPdfPath').value;
        const slug = existingSlug || slugify(title);
        const path = `${CONFIG.productsPath}/${slug}.md`;
        const isEdit = !!sha;

        // For existing products, fetch the latest SHA to avoid conflicts
        let currentSha = sha;
        if (isEdit) {
          try {
            const latestFile = await apiRequest('get', path);
            if (latestFile && latestFile.sha) {
              currentSha = latestFile.sha;
            }
          } catch {
            // File might not exist if it was just created, use existing sha
          }
        }

        try {
          // Handle PDF upload/removal
          if (pendingPdfFile) {
            saveBtn.textContent = 'Uploading PDF...';
            const progressBar = document.getElementById('pdfUploadProgress');
            const progressBarInner = document.getElementById('pdfUploadProgressBar');
            progressBar.classList.add('active');
            progressBarInner.style.width = '50%';

            pdfPath = await uploadPdf(pendingPdfFile, slug);

            progressBarInner.style.width = '100%';
            saveBtn.textContent = 'Saving...';
          } else if (pendingPdfRemove && pdfPath) {
            saveBtn.textContent = 'Removing PDF...';
            await deletePdf(pdfPath);
            pdfPath = '';
          }

          // Build the new/updated product object
          const updatedProduct = {
            title,
            category,
            size,
            order,
            inStock,
            pdf: pdfPath || undefined,
            slug,
            sha: sha || 'pending',
            path,
            body: '',
          };

          // Optimistic update
          if (isEdit) {
            const idx = products.findIndex((p) => p.slug === slug);
            if (idx !== -1) {
              updatedProduct.sha = products[idx].sha;
              products[idx] = updatedProduct;
            }
          } else {
            products.push(updatedProduct);
          }
          sortProducts();
          renderProducts();
          closeProductModal();
          setCache({ products, jobs });
          updateStatus(`${isEdit ? 'Updated' : 'Added'} "${title}". Saving to database...`);

          // Build frontmatter with optional PDF field
          let content = `---
title: ${yamlString(title)}
category: ${yamlString(category)}
size: ${yamlString(size)}
order: ${order}
inStock: ${inStock}`;

          if (pdfPath) {
            content += `\npdf: ${pdfPath}`;
          }

          content += `\n---\n`;

          await saveFile(path, content, currentSha || null, `${isEdit ? 'Update' : 'Add'} product: ${title}`);
          showRebuildNotice();
          updateStatus(`Product "${title}" saved successfully.`);
        } catch (err) {
          alert('Error saving product: ' + err.message + '\n\nClick "Refresh from Database" to reload.');
          updateStatus('Error saving. Please refresh.');
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save';
          resetPdfUpload();
        }
      });

      // ============================================
      // JOBS
      // ============================================

      let jobs = [];

      function sortJobs() {
        jobs.sort((a, b) => (a.order || 0) - (b.order || 0));
      }

      async function loadJobs(fromGitHub = false) {
        if (!fromGitHub) return; // Only fetch if explicitly requested

        const files = await getFiles(CONFIG.jobsPath);
        if (!files || !Array.isArray(files)) {
          document.getElementById('jobsLoading').textContent = 'No jobs found or error loading.';
          return;
        }

        jobs = [];

        for (const file of files) {
          if (file.name.endsWith('.md')) {
            try {
              const { content, sha } = await getFileContent(file.path);
              const job = parseMarkdown(content);
              job.slug = file.name.replace('.md', '');
              job.sha = sha;
              job.path = file.path;
              jobs.push(job);
            } catch (err) {
              console.error('Error loading job:', file.name, err);
            }
          }
        }

        sortJobs();
        renderJobs();
      }

      function renderJobs() {
        const loading = document.getElementById('jobsLoading');
        const table = document.getElementById('jobsTable');
        const tbody = document.getElementById('jobsBody');

        loading.style.display = 'none';
        table.style.display = 'table';

        tbody.innerHTML = jobs
          .map(
            (j) => `
        <tr>
          <td>${escapeHtml(j.title || '')}</td>
          <td>${escapeHtml(j.locations || 'All Locations')}</td>
          <td>${j.order || 0}</td>
          <td><span class="badge ${j.active !== false ? 'badge-success' : 'badge-warning'}">${j.active !== false ? 'Active' : 'Inactive'}</span></td>
          <td class="action-buttons">
            <button class="btn btn-secondary btn-small" onclick="editJob('${j.slug}')">Edit</button>
            <button class="btn btn-danger btn-small" onclick="deleteJob('${j.slug}')">Delete</button>
          </td>
        </tr>
      `
          )
          .join('');
      }

      function openJobModal(job = null) {
        document.getElementById('jobModalTitle').textContent = job ? 'Edit Job' : 'Add Job';
        document.getElementById('jobSlug').value = job?.slug || '';
        document.getElementById('jobSha').value = job?.sha || '';
        document.getElementById('jobTitle').value = job?.title || '';
        document.getElementById('jobLocations').value = job?.locations || '';
        document.getElementById('jobOrder').value = job?.order || 0;
        document.getElementById('jobActive').checked = job?.active !== false;
        document.getElementById('jobBody').value = job?.body || '';
        document.getElementById('jobModal').classList.add('active');
      }

      function closeJobModal() {
        document.getElementById('jobModal').classList.remove('active');
      }

      window.editJob = function (slug) {
        const job = jobs.find((j) => j.slug === slug);
        if (job) openJobModal(job);
      };

      window.deleteJob = async function (slug) {
        if (!confirm('Are you sure you want to delete this job?')) return;

        const jobIndex = jobs.findIndex((j) => j.slug === slug);
        if (jobIndex === -1) return;

        const job = jobs[jobIndex];

        // Optimistic update - remove from local array immediately
        jobs.splice(jobIndex, 1);
        renderJobs();
        setCache({ products, jobs });
        updateStatus(`Deleted "${job.title}". Saving to database...`);

        try {
          // Fetch the latest SHA to avoid 409 conflicts
          let currentSha = job.sha;
          try {
            const latestFile = await apiRequest('get', job.path);
            if (latestFile && latestFile.sha) {
              currentSha = latestFile.sha;
            }
          } catch {
            // Use existing sha if we can't fetch latest
          }

          await deleteFile(job.path, currentSha, `Delete job: ${job.title}`);
          showRebuildNotice();
          updateStatus(`Job "${job.title}" deleted successfully.`);
        } catch (err) {
          // Revert on error
          jobs.splice(jobIndex, 0, job);
          renderJobs();
          setCache({ products, jobs });
          alert('Error deleting job: ' + err.message);
          updateStatus('Error deleting job.');
        }
      };

      document.getElementById('addJobBtn').addEventListener('click', () => openJobModal());

      document.getElementById('jobForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const saveBtn = document.getElementById('jobSaveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const existingSlug = document.getElementById('jobSlug').value;
        const sha = document.getElementById('jobSha').value;
        const title = document.getElementById('jobTitle').value;
        const locations = document.getElementById('jobLocations').value || 'All Locations';
        const active = document.getElementById('jobActive').checked;
        const order = parseInt(document.getElementById('jobOrder').value) || 0;
        const body = document.getElementById('jobBody').value;
        const slug = existingSlug || slugify(title);
        const path = `${CONFIG.jobsPath}/${slug}.md`;
        const isEdit = !!sha;

        // For existing jobs, fetch the latest SHA to avoid conflicts
        let currentSha = sha;
        if (isEdit) {
          try {
            const latestFile = await apiRequest('get', path);
            if (latestFile && latestFile.sha) {
              currentSha = latestFile.sha;
            }
          } catch {
            // File might not exist if it was just created, use existing sha
          }
        }

        // Build the new/updated job object
        const updatedJob = {
          title,
          locations,
          active,
          order,
          slug,
          sha: sha || 'pending',
          path,
          body,
        };

        // Optimistic update
        if (isEdit) {
          const idx = jobs.findIndex((j) => j.slug === slug);
          if (idx !== -1) {
            updatedJob.sha = jobs[idx].sha;
            jobs[idx] = updatedJob;
          }
        } else {
          jobs.push(updatedJob);
        }
        sortJobs();
        renderJobs();
        closeJobModal();
        setCache({ products, jobs });
        updateStatus(`${isEdit ? 'Updated' : 'Added'} "${title}". Saving to database...`);

        const content = `---
title: ${yamlString(title)}
locations: ${yamlString(locations)}
active: ${active}
order: ${order}
---
${body}
`;

        try {
          await saveFile(path, content, currentSha || null, `${isEdit ? 'Update' : 'Add'} job: ${title}`);
          showRebuildNotice();
          updateStatus(`Job "${title}" saved successfully.`);
        } catch (err) {
          alert('Error saving job: ' + err.message + '\n\nClick "Refresh from Database" to reload.');
          updateStatus('Error saving. Please refresh.');
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save';
        }
      });

      // ============================================
      // HELPERS
      // ============================================

      function slugify(text) {
        return text
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      }

      // Quote YAML string values that might be interpreted as numbers or contain special chars
      function yamlString(value) {
        if (!value) return '';
        // If it looks like a number or contains special YAML chars, wrap in quotes
        if (/^[\d.]+$/.test(value) || /[:#\[\]{}|>&*!?,]/.test(value) || value.includes('"') || value.includes("'")) {
          // Escape any double quotes and wrap in double quotes
          return '"' + value.replace(/"/g, '\\"') + '"';
        }
        return value;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function parseMarkdown(content) {
        const result = { body: '' };
        const match = content.match(/^---\n([\s\S]*?)\n---\n?([\s\S]*)$/);

        if (match) {
          const frontmatter = match[1];
          result.body = match[2].trim();

          frontmatter.split('\n').forEach((line) => {
            const colonIndex = line.indexOf(':');
            if (colonIndex > 0) {
              const key = line.substring(0, colonIndex).trim();
              let value = line.substring(colonIndex + 1).trim();

              if (value === 'true') value = true;
              else if (value === 'false') value = false;
              else if (!isNaN(Number(value)) && value !== '') value = Number(value);

              result[key] = value;
            }
          });
        }

        return result;
      }

      function showRebuildNotice() {
        const notice = document.getElementById('rebuildNotice');
        notice.classList.add('active');
        setTimeout(() => notice.classList.remove('active'), 10000);
      }

      function updateStatus(text) {
        document.getElementById('statusText').textContent = text;
      }

      async function loadData(forceRefresh = false) {
        const refreshBtn = document.getElementById('refreshBtn');

        // Try to load from cache first (unless forcing refresh)
        if (!forceRefresh) {
          const cached = getCache();
          if (cached && cached.products && cached.jobs) {
            products = cached.products;
            jobs = cached.jobs;
            renderProducts();
            renderJobs();
            updateCategoriesFromProducts();
            const cacheAge = Math.round((Date.now() - cached.timestamp) / 60000);
            updateStatus(
              `Showing cached data (${cacheAge} min old). ${products.length} products, ${jobs.length} jobs.`
            );
            refreshBtn.style.display = 'inline-block';
            return;
          }
        }

        // Fetch fresh data from database
        updateStatus(forceRefresh ? 'Refreshing from database...' : 'Loading content from database...');
        refreshBtn.style.display = 'none';

        try {
          await Promise.all([loadProducts(true), loadJobs(true)]);

          // Save to cache
          setCache({ products, jobs });

          updateStatus(`Loaded ${products.length} products and ${jobs.length} jobs.`);
          refreshBtn.style.display = 'inline-block';
        } catch (err) {
          updateStatus('Error loading data: ' + err.message);
          refreshBtn.style.display = 'inline-block';
        }
      }

      // Refresh button handler
      document.getElementById('refreshBtn').addEventListener('click', () => {
        loadData(true);
      });

      // Initialize
      loadCategories();
      setupPdfUpload();
      checkSession();
    </script>
  </body>
</html>
